version: "3.8"

# Docker Swarm Stack (PRD) - node label placement + Docker Config/Secret for app config
#
# Node label plan:
#   role=manager   : HAProxy / Swarm management
#   role=api       : API service
#   role=scheduler : Scheduler service
#   role=consumer  : Consumer service
#   role=db        : MariaDB
#   role=cache     : Redis
#   role=mq        : Kafka / Kafka Connect
#   role=olap      : ClickHouse
#   role=docdb     : MongoDB
#
# Kafka (KRaft) plan:
#   - 3 brokers: kafka01 / kafka02 / kafka03
#   - Each broker is a dedicated service with fixed NODE_ID and pinned to a specific host.

# =========================
# Oracle Services
# =========================
x-oracle-services: &oracle-services
  image: 480126395291.dkr.ecr.ap-east-1.amazonaws.com/igaming/oracle/app:develop
  environment:
    TZ: Asia/Taipei
    # Logging
    LOG_LEVEL: info
    LOG_ENCODING: json
    LOG_OUTPUT_PATHS: stdout
    LOG_ERROR_OUTPUT_PATHS: stderr
    # Database
    DB_HOST: mariadb
    DB_PORT: 3306
    DB_DATABASE: ${DB_DATABASE:-oracle_db}
    DB_USERNAME: ${DB_USERNAME:-oracle}
    DB_PASSWORD: ${DB_PASSWORD:-oracle_password}
    # Redis
    REDIS_HOST: redis
    REDIS_PORT: 6379
    # Kafka brokers
    KAFKA_BROKERS: kafka01:9092,kafka02:9092,kafka03:9092
    # Kafka Connect
    KAFKA_CONNECT_URL: http://kafka-connect:8083
    KAFKA_CONNECT_SERVER_ID: 1
    KAFKA_CONNECT_BROKERS: kafka01:9092,kafka02:9092,kafka03:9092
    KAFKA_CONNECT_DATABASE_HOST: mariadb
    KAFKA_CONNECT_DATABASE_PORT: 3306
    KAFKA_CONNECT_DATABASE_USERNAME: ${DB_USERNAME:-oracle}
    KAFKA_CONNECT_DATABASE_PASSWORD: ${DB_PASSWORD:-oracle_password}
    # ClickHouse
    CLICKHOUSE_HOST: clickhouse
    CLICKHOUSE_PORT: 9000
    CLICKHOUSE_DATABASE: ${CLICKHOUSE_DATABASE:-oracle_analytics}
    CLICKHOUSE_USERNAME: ${CLICKHOUSE_USERNAME:-oracle}
    CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-oracle_password}
    # MongoDB
    MONGODB_HOST: mongodb
    MONGODB_PORT: 27017
    MONGODB_DATABASE: ${MONGODB_DATABASE:-oracle_mdb}
    MONGODB_USERNAME: ${MONGODB_USERNAME:-oracle}
    MONGODB_PASSWORD: ${MONGODB_PASSWORD:-oracle_password}
    MONGODB_AUTH_SOURCE: admin
  configs:
    - source: oracle_config
      target: /app/deploy/config.yaml
      mode: 0444
  networks:
    - oracle-network
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

# =========================
# Kafka (KRaft) â€“ shared template
# =========================
x-kafka-env: &kafka-env
  KAFKA_PROCESS_ROLES: broker,controller
  CLUSTER_ID: Y1LZj0gBQ4u2GsAHmcHGww
  KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka01:9093,2@kafka02:9093,3@kafka03:9093"
  KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
  KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
  KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
  KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
  KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
  KAFKA_NUM_PARTITIONS: 3
  KAFKA_DEFAULT_REPLICATION_FACTOR: 3
  KAFKA_MIN_INSYNC_REPLICAS: 2
  KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
  KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
  KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
  KAFKA_LOG_RETENTION_HOURS: 168
  KAFKA_LOG_SEGMENT_BYTES: 1073741824
  KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS: 300000
  KAFKA_LOG_CLEANUP_POLICY: delete
  KAFKA_METADATA_LOG_DIR: /var/lib/kafka/metadata
  TZ: Asia/Taipei

x-kafka-deploy: &kafka-deploy
  replicas: 1
  restart_policy:
    condition: on-failure
    delay: 5s
    max_attempts: 3
    window: 120s
  resources:
    limits:
      cpus: "1"
      memory: 4G

x-kafka-services: &kafka-service
  image: confluentinc/cp-kafka:7.4.0
  user: "0"
  networks:
    - oracle-network
  entrypoint:
    - "/bin/bash"
    - "-c"
    - >-
      /etc/confluent/docker/configure && mkdir -p /var/lib/kafka/metadata
      && chown -R appuser:appuser /var/lib/kafka/metadata && chmod 755 /var/lib/kafka/metadata
      && if [ ! -f /var/lib/kafka/metadata/meta.properties ]; then echo 'Formatting Kafka metadata directory...'
      && su appuser -s /bin/bash -c "kafka-storage format -t $${CLUSTER_ID} -c /etc/kafka/kafka.properties --ignore-formatted"
      && echo 'Metadata directory formatted'; else echo 'Metadata directory already formatted'; fi
      && exec /etc/confluent/docker/run
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
  deploy:
    <<: *kafka-deploy
  healthcheck:
    test: ["CMD", "nc", "-z", "localhost", "9092"]
    interval: 15s
    timeout: 5s
    retries: 8
    start_period: 60s

services:
  # =========================
  # Database: MariaDB
  # =========================
  mariadb:
    image: mariadb:10.11
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root_password}
      MARIADB_DATABASE: ${DB_DATABASE:-oracle_db}
      MARIADB_USER: ${DB_USERNAME:-oracle}
      MARIADB_PASSWORD: ${DB_PASSWORD:-oracle_password}
      TZ: Asia/Taipei
    ports:
      - target: 3306
        published: 3306
        protocol: tcp
        mode: ingress
    volumes:
      - mariadb_data:/var/lib/mysql
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max-connections=1000
      - --innodb_flush_log_at_trx_commit=1
      - --sync_binlog=1
    networks:
      - oracle-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          # docker command: docker node update --label-add role.db=master <node_id>
          - node.labels.role.db == master
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${MARIADB_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =========================
  # Cache: Redis
  # =========================
  redis:
    image: redis:7-alpine
    ports:
      - target: 6379
        published: 6379
        protocol: tcp
        mode: ingress
    volumes:
      - redis_data:/data
    networks:
      - oracle-network
    command: ["redis-server", "--appendonly", "yes"]
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          # docker command: docker node update --label-add role.cache=true <node_id>
          - node.labels.role.cache == true
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =========================
  # Document DB: MongoDB
  # =========================
  mongodb:
    image: mongo:7.0
    ports:
      - target: 27017
        published: 27017
        protocol: tcp
        mode: ingress
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME:-oracle}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD:-oracle_password}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-oracle_mdb}
      TZ: Asia/Taipei
    volumes:
      - mongodb_data:/data/db
    networks:
      - oracle-network
    command: ["mongod", "--auth"]
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          # docker command: docker node update --label-add role.mdb=true <node_id>
          - node.labels.role.mdb == true
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =========================
  # OLAP: ClickHouse
  # =========================
  clickhouse:
    image: clickhouse/clickhouse-server:23.11
    ports:
      - target: 8123
        published: 8123
        protocol: tcp
        mode: ingress
      - target: 9000
        published: 9000
        protocol: tcp
        mode: ingress
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-oracle_analytics}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-oracle}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-oracle_password}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
      TZ: Asia/Taipei
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    networks:
      - oracle-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          # docker command: docker node update --label-add role.olap=true <node_id>
          - node.labels.role.olap == true
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  # =========================
  # MQ: Kafka (KRaft 3 brokers)
  # =========================
  kafka01:
    <<: *kafka-service
    environment:
      <<: [*kafka-env, { KAFKA_NODE_ID: 1, KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://oracle_kafka01:9092 }]
    volumes:
      - kafka01_data:/var/lib/kafka/data
      - kafka01_metadata:/var/lib/kafka/metadata
    deploy:
      <<: *kafka-deploy
      placement:
        constraints:
          # docker command: docker node update --label-add role.kafka=1 <node_id>
          - node.labels.role.kafka == 1

  kafka02:
    <<: *kafka-service
    environment:
      <<: [*kafka-env, { KAFKA_NODE_ID: 2, KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://oracle_kafka02:9092 }]
    volumes:
      - kafka02_data:/var/lib/kafka/data
      - kafka02_metadata:/var/lib/kafka/metadata
    deploy:
      <<: *kafka-deploy
      placement:
        constraints:
          # docker command: docker node update --label-add role.kafka=2 <node_id>
          - node.labels.role.kafka == 2

  kafka03:
    <<: *kafka-service
    environment:
      <<: [*kafka-env, { KAFKA_NODE_ID: 3, KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://oracle_kafka03:9092 }]
    volumes:
      - kafka03_data:/var/lib/kafka/data
      - kafka03_metadata:/var/lib/kafka/metadata
    deploy:
      <<: *kafka-deploy
      placement:
        constraints:
          # docker command: docker node update --label-add role.kafka=3 <node_id>
          - node.labels.role.kafka == 3

  # =========================
  # Kafka Connect (Debezium)
  # =========================
  kafka-connect:
    image: 480126395291.dkr.ecr.ap-east-1.amazonaws.com/igaming/kafka-connect:latest
    ports:
      - target: 8083
        published: 8083
        protocol: tcp
        mode: ingress
    environment:
      TZ: Asia/Taipei
      BOOTSTRAP_SERVERS: kafka01:9092,kafka02:9092,kafka03:9092
      GROUP_ID: oracle-connect-cluster
      CONFIG_STORAGE_TOPIC: connect-configs
      OFFSET_STORAGE_TOPIC: connect-offsets
      STATUS_STORAGE_TOPIC: connect-status
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 3
      KEY_CONVERTER: org.apache.kafka.connect.storage.StringConverter
      VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      VALUE_CONVERTER_SCHEMAS_ENABLE: "false"
      KAFKA_CONNECT_PLUGINS_DIR: /kafka/connect,/kafka/connect/plugins
      HEAP_OPTS: "-Xms1g -Xmx3g"
    networks:
      - oracle-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          # docker command: docker node update --label-add role.mq=true <node_id>
          - node.labels.role.cdc == true
      resources:
        limits:
          cpus: "2"
          memory: 6G
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:8083/"]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 120s

  # =========================
  # Nginx Load Balancer
  # =========================
  nginx:
    image: ubuntu/nginx:1.18-22.04_edge
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: ingress
    configs:
      - source: nginx_config
        target: /etc/nginx/sites-enabled/default
        mode: 0444
    networks:
      - oracle-network
    volumes:
      - /var/www:/var/www
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      placement:
        constraints:
          # docker command: docker node update --label-add role.web=true <node_id>
          - node.labels.role.web == true
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:7351/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # =========================
  # Oracle API service (server)
  # =========================
  api:
    <<: *oracle-services
    command: server
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 0s
        failure_action: pause
        order: stop-first
      placement:
        constraints:
          # docker command: docker node update --label-add role.api=true <node_id>
          - node.labels.role.api == true
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:7350/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =========================
  # Kafka Consumer service
  # =========================
  consumer:
    <<: *oracle-services
    command: consumer
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          # docker command: docker node update --label-add role.consumer=true <node_id>
          - node.labels.role.consumer == true
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[c]onsumer' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # =========================
  # Scheduler service
  # =========================
  scheduler:
    <<: *oracle-services
    command: scheduler
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          # docker command: docker node update --label-add role.scheduler=true <node_id>
          - node.labels.role.scheduler == true
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[s]cheduler' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  oracle-network:
    driver: overlay
    attachable: true

configs:
  nginx_config:
    file: ./config/nginx/oracle.conf
  oracle_config:
    file: ./deploy/config.yaml

volumes:
  mariadb_data:
    driver: local
  redis_data:
    driver: local
  mongodb_data:
    driver: local

  kafka01_data:
    driver: local
  kafka01_metadata:
    driver: local
  kafka02_data:
    driver: local
  kafka02_metadata:
    driver: local
  kafka03_data:
    driver: local
  kafka03_metadata:
    driver: local

  clickhouse_data:
    driver: local
