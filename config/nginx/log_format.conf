# JSON access log formats for ELK; escape=json quotes and escapes values.
# Use $time_iso8601 for parseable timestamps; request_time/bytes_sent for analytics.

# Map status code to log level (e.g. 502 -> error, 4xx -> warn, 2xx/3xx -> info)
map $status $log_level {
    default "info";
    400 "warn"; 401 "warn"; 403 "warn"; 404 "warn"; 405 "warn";
    408 "warn"; 413 "warn"; 414 "warn"; 429 "warn";
    500 "error"; 502 "error"; 503 "error"; 504 "error";
}

# ECS/ELK-style field names (see https://www.elastic.co/guide/en/ecs/current/ecs-field-reference.html)
log_format ecs escape=json '{'
  '"@timestamp":"$time_iso8601",'
  '"log.level":"$log_level",'
  '"http.response.status_code":$status,'
  '"http.request.method":"$request_method",'
  '"url.scheme":"$scheme",'
  '"url.domain":"$host",'
  '"url.path":"$uri",'
  '"url.query":"$query_string",'
  '"http.request.duration_sec":$request_time,'
  '"http.response.body.bytes":$body_bytes_sent,'
  '"http.request.bytes":$request_length,'
  '"source.address":"$http_x_forwarded_for",'
  '"client.address":"$remote_addr",'
  '"http.request.referrer":"$http_referer",'
  '"user_agent.original":"$http_user_agent",'
  '"http.response.content_type":"$sent_http_content_type",'
  '"nginx.upstream_cache_status":"$upstream_cache_status",'
  '"nginx.upstream_response_time":"$upstream_response_time"'
'}';