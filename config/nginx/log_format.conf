# JSON access log formats for ELK; escape=json quotes and escapes values.
# Use $time_iso8601 for parseable timestamps; request_time/bytes_sent for analytics.

# Map status code to log level (e.g. 502 -> error, 4xx -> warn, 2xx/3xx -> info)
map $status $log_level {
    default "info";
    400 "warn"; 401 "warn"; 403 "warn"; 404 "warn"; 405 "warn";
    408 "warn"; 413 "warn"; 414 "warn"; 429 "warn";
    500 "error"; 502 "error"; 503 "error"; 504 "error";
}

log_format json_info escape=json '{'
  '"@timestamp":"$time_iso8601",'
  '"level":"$log_level",'
  '"status":$status,'
  '"method":"$request_method",'
  '"scheme":"$scheme",'
  '"host":"$host",'
  '"uri":"$request_uri",'
  '"query_string":"$query_string",'
  '"request_time":$request_time,'
  '"body_bytes_sent":$body_bytes_sent,'
  '"request_length":$request_length,'
  '"remote_addr":"$remote_addr",'
  '"x_forwarded_for":"$http_x_forwarded_for",'
  '"referer":"$http_referer",'
  '"user_agent":"$http_user_agent",'
  '"content_type":"$sent_http_content_type",'
  '"upstream_cache_status":"$upstream_cache_status",'
  '"upstream_response_time":"$upstream_response_time"'
'}';