version: "3.8"

services:
  server:
    image: hashicorp/consul:1.19.0
    network_mode: host
    configs:
      - source: server_config
        target: /etc/consul/consul.hcl
        mode: 0444
    volumes:
      - server_data:/consul/data
    command: ["consul", "agent", "-config-file=/etc/consul/consul.hcl"]
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          - node.role == manager
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5

  client:
    image: hashicorp/consul:1.19.0
    environment:
      # Consul Server 的 IP（該節點 ens5 私網 IP），必填或改 consul-client.hcl 預設值
      - CONSUL_SERVER_IP=${CONSUL_SERVER_IP:-10.0.2.11}
    network_mode: host
    configs:
      - source: client_config
        target: /etc/consul/consul.hcl
        mode: 0444
    volumes:
      - client_data:/consul/data
    command: ["consul", "agent", "-config-file=/etc/consul/consul.hcl"]
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5

configs:
  server_config:
    file: ./config/consul/consul-server.hcl
  client_config:
    file: ./config/consul/consul-client.hcl

volumes:
  server_data:
    driver: local
  client_data:
    driver: local